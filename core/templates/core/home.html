<!DOCTYPE html>
<html>
    <head>
        <title>Cotizador Solar</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <!-- Tailwind CSS -->
        <script src="https://cdn.tailwindcss.com"></script>
        
        <!-- Font Awesome -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        
        <!-- Google Fonts -->
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        fontFamily: {
                            sans: ['Inter', 'sans-serif'],
                        },
                        colors: {
                            'primary': '#10b981',
                            'primary-hover': '#059669',
                        }
                    }
                }
            }
        </script>
        <style>
            /* Gradient background */
            .gradient-bg {
                background: linear-gradient(135deg, #f0fdf4 0%, #ccfbf1 100%);
            }

            body {
                font-family: 'Inter', sans-serif;
                background-color: #eef5f8;
            }

            /* Estilos para inputs y selects */
            .custom-input, .custom-select {
                width: 100%;
                padding: 0.75rem 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                background-color: white;
                transition: all 0.2s;
                font-size: 0.95rem;
                line-height: 1.5;
                color: #1f2937;
            }

            .custom-input:focus, .custom-select:focus {
                outline: none;
                border-color: #10b981;
                box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            }

            /* Estilo para selects */
            .custom-select {
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
                background-position: right 0.5rem center;
                background-repeat: no-repeat;
                background-size: 1.5em 1.5em;
                padding-right: 2.5rem;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }

            /* Estilos para checkboxes */
            input[type="checkbox"] {
                border-radius: 0.25rem;
                border-color: #d1d5db;
            }

            input[type="checkbox"]:checked {
                background-color: #10b981;
                border-color: #10b981;
            }

            /* Estilos para tooltips */
            .help-icon {
                color: #9ca3af;
                transition: color 0.2s;
            }

            .help-icon:hover {
                color: #6b7280;
            }

            /* Estilos para el contenedor principal */
            .form-container {
                background: white;
                border-radius: 1rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }

            /* Barra de progreso */
            .progress-bar {
                transition: width 0.3s ease-in-out;
            }

            /* Animaciones */
            .form-page {
                transition: all 0.3s ease-in-out;
            }

            /* Estilos para botones */
            .custom-button {
                padding: 0.75rem 1.5rem;
                border-radius: 0.5rem;
                font-weight: 500;
                transition: all 0.2s;
            }

            .primary-button {
                background-color: #10b981;
                color: white;
            }

            .primary-button:hover {
                background-color: #059669;
            }

            .secondary-button {
                background-color: #f3f4f6;
                color: #1f2937;
            }

            .secondary-button:hover {
                background-color: #e5e7eb;
            }
        </style>
    </head>
<body>

    <script id="tejas-data" type="application/json">
        {{ tejas|safe }}
    </script>
    <script id="paneles-data" type="application/json">
        {{ paneles|safe }}
    </script>
    <script id="inversores-data" type="application/json">
        {{ inversores|safe }}
    </script>
    <script id="datos_externos-data" type="application/json">
        {{ datos_externos|safe }}
    </script>
    <script id="estudio_conexion-data" type="application/json">
        {{ estudios_conexion|safe }}
    </script>
    <!-- Logo -->
    {% load static %}
    <div class="absolute top-6 left-6">
        <img src="{% static 'img/logo.png' %}" alt="Logo" class="h-12">
    </div>
    <!-- Contenedor principal -->
    <div class="min-h-screen flex items-center justify-center p-6">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl">
            <!-- Barra de progreso -->
            <div class="h-2 bg-gray-100 rounded-t-xl">
                <div id="progress-bar" class="h-2 bg-emerald-500 rounded-t-xl transition-all duration-300" style="width: 0%"></div>
            </div>

            <!-- Contenido del formulario -->
            <div class="p-8">
                <div id="form-pages">
                    <!-- Página 1: Datos del Cliente -->
                    <div class="form-page active" data-page="1">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-8">Datos del Cliente</h2>
                        <div class="space-y-6">
                            <!-- Nombre completo -->
                            <div class="relative">
                                <label class="form-label flex items-center">
                                    Nombre Completo
                                    <span class="help-icon" title="Ingrese su nombre completo como aparece en su documento de identidad y factura de energía">
                                        <i class="fas fa-circle-question text-sm"></i>
                                    </span>
                                </label>
                                <input type="text" id="fullName" class="custom-input">
                            </div>

                            <!-- Grid de 2 columnas para consumo y costo -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Consumo Cliente -->
                                <div class="relative">
                                    <label class="form-label flex items-center">
                                        Consumo Cliente (kWh/mes)
                                        <span class="help-icon" title="Ingrese su consumo promedio mensual de energía eléctrica">
                                            <i class="fas fa-circle-question text-sm"></i>
                                        </span>
                                    </label>
                                    <input type="number" id="consumption" class="custom-input">
                                </div>

                                <!-- Costo $/kwh -->
                                <div class="relative">
                                    <label class="form-label flex items-center">
                                        Costo ($/kWh)
                                        <span class="help-icon" title="Valor del kilowatt hora que aparece en su factura">
                                            <i class="fas fa-circle-question text-sm"></i>
                                        </span>
                                    </label>
                                    <input type="number" id="costPerKwh" class="custom-input">
                                </div>
                            </div>

                            <!-- Grid de 2 columnas para contribución y total -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Contribución -->
                                <div class="relative">
                                    <label class="form-label flex items-center">
                                        Contribución
                                        <span class="help-icon" title="Porcentaje de contribución aplicado a su factura">
                                            <i class="fas fa-circle-question text-sm"></i>
                                        </span>
                                    </label>
                                    <div class="relative">
                                        <input type="number" id="contribution" value="20" class="custom-input pr-12">
                                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500">%</span>
                                    </div>
                                </div>

                                <!-- Total Factura -->
                                <div class="relative">
                                    <label class="form-label flex items-center">
                                        Total Facturado ($)
                                        <span class="help-icon" title="Este valor se calcula automáticamente">
                                            <i class="fas fa-circle-question text-sm"></i>
                                        </span>
                                    </label>
                                    <input type="text" id="totalBill" readonly class="custom-input bg-gray-50">
                                </div>
                            </div>

                            <!-- Grid de 2 columnas para transformador y área -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <!-- Transformador -->
                                <div class="relative">
                                    <label class="form-label flex items-center">
                                        Transformador Cliente (kVA)
                                        <span class="help-icon" title="Capacidad del transformador que alimenta su instalación">
                                            <i class="fas fa-circle-question text-sm"></i>
                                        </span>
                                    </label>
                                    <input type="number" id="transformer" class="custom-input">
                                </div>

                                <!-- Área disponible -->
                                <div class="relative">
                                    <label class="form-label flex items-center">
                                        Área disponible (m²)
                                        <span class="help-icon" title="Espacio total disponible para la instalación">
                                            <i class="fas fa-circle-question text-sm"></i>
                                        </span>
                                    </label>
                                    <input type="number" id="availableArea" class="custom-input">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Página 2: Selección de Paneles -->
                    <div class="form-page hidden" data-page="2">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-8">Selección de Paneles Solares</h2>
                        
                        <!-- Selector de modo -->
                        <div class="mb-8">
                            <div class="inline-flex rounded-lg border border-gray-200 p-1 bg-gray-50">
                                <button type="button" id="manualModeBtn" class="custom-button primary-button rounded-md">
                                    Selección de paneles
                                </button>
                                <button type="button" id="autoModeBtn" class="custom-button secondary-button rounded-md">
                                    Estimación de paneles
                                </button>
                            </div>
                        </div>

                        <!-- Modo Manual -->
                        <div id="manualMode" class="space-y-6">
                            <!-- Panel Solar -->
                            <div class="relative">
                                <label class="form-label flex items-center">
                                    Panel Solar
                                    <span class="help-icon" title="Seleccione el modelo de panel solar">
                                        <i class="fas fa-circle-question text-sm"></i>
                                    </span>
                                </label>
                                <select id="panelSelect" class="custom-select">
                                    <option value="">Seleccione un panel</option>
                                </select>
                                <div id="panelInfo" class="mt-2 text-sm text-gray-600"></div>
                            </div>

                            <!-- Cantidad de Paneles -->
                            <div class="relative">
                                <label class="form-label flex items-center">
                                    Cantidad de Paneles
                                    <span class="help-icon" title="Número de paneles a instalar">
                                        <i class="fas fa-circle-question text-sm"></i>
                                    </span>
                                </label>
                                <input type="number" id="panelQuantity" min="0" class="custom-input">
                            </div>

                            <!-- Cobertura Energética -->
                            <div class="bg-emerald-50 p-6 rounded-lg">
                                <h3 class="font-medium text-emerald-900 mb-2">Cobertura Energética</h3>
                                <div id="coverageInfo" class="text-emerald-800"></div>
                            </div>
                        </div>

                        <!-- Modo Automático -->
                        <div id="autoMode" class="space-y-6 hidden">
                            <div class="relative">
                                <label class="form-label flex items-center">
                                    Porcentaje de energía que le gustaria suplir usando paneles
                                    <span class="help-icon" title="Indique qué porcentaje de su consumo actual desea cubrir con energía solar">
                                        <i class="fas fa-circle-question text-sm"></i>
                                    </span>
                                </label>
                                <div class="relative">
                                    <input type="number" 
                                           id="desiredCoverage" 
                                           min="1" 
                                           max="100" 
                                           class="custom-input pr-12" 
                                    >
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                        <span class="text-gray-500">%</span>
                                    </div>
                                </div>
                            </div>
                        
                            <div class="bg-emerald-50 p-6 rounded-lg mt-4">
                                <h3 class="font-medium text-emerald-900">Recomendación del Sistema</h3>
                                <div id="recommendationInfo" class="mt-2 text-emerald-800">
                                    <!-- La recomendación se mostrará aquí -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Página 3: Equipos y Servicios -->
                    <div class="form-page hidden" data-page="3">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-8">Equipos y Servicios Adicionales</h2>
                        <div class="space-y-8">
                            <!-- Inversores -->
                            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Inversores</h3>
                                <div class="space-y-4">
                                    <div class="relative">
                                        <label class="form-label flex items-center">
                                            Inversor
                                            <span class="help-icon" title="Seleccione el inversor adecuado para su sistema">
                                                <i class="fas fa-circle-question text-sm"></i>
                                            </span>
                                        </label>
                                        <select id="inversorSelect" class="custom-select">
                                            <option value="">Seleccione un inversor</option>
                                        </select>
                                    </div>
                                    <div class="relative">
                                        <label class="form-label flex items-center">
                                            Cantidad de Inversores
                                            <span class="help-icon" title="Número de inversores a instalar">
                                                <i class="fas fa-circle-question text-sm"></i>
                                            </span>
                                        </label>
                                        <input type="number" id="inversorQuantity_input" min="0" value="1" class="custom-input">
                                    </div>
                                    <div id="inversorInfo" class="mt-2 text-sm text-gray-600"></div>
                                </div>
                            </div>

                            <!-- Viáticos y Personal -->
                            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Viáticos y Personal</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label class="form-label">Días de trabajo</label>
                                        <input type="number" id="workDays" min="1" max="30" value="2" class="custom-input">
                                        <p class="mt-1 text-sm text-gray-500">Mínimo 1 día</p>
                                    </div>
                                    <div>
                                        <label class="form-label">Número de trabajadores</label>
                                        <input type="number" id="workers" min="1" max="10" value="2" class="custom-input">
                                        <p class="mt-1 text-sm text-gray-500">Mínimo 1 trabajador</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Ubicación -->
                            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Ubicación</h3>
                                <div class="space-y-4">
                                    <select id="locationSelect" class="custom-select">
                                        <option value="">Seleccione una ubicación</option>
                                        <option value="custom">Otra ubicación</option>
                                    </select>
                                    <div id="customLocationDiv" class="space-y-4 hidden">
                                        <input type="text" id="customLocation" placeholder="Nombre de la ciudad" class="custom-input">
                                        <input type="number" id="customDistance" placeholder="Distancia en km desde Medellín" class="custom-input">
                                    </div>
                                </div>
                            </div>

                            <!-- Export Manager -->
                            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-100">
                                <div class="mb-4">
                                    <a href="#" class="text-emerald-500 hover:text-emerald-600 flex items-center gap-2">
                                        <i class="fas fa-play-circle"></i>
                                        Ver video explicativo sobre Export Manager
                                    </a>
                                </div>
                                <div class="space-y-4">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" id="exportManager" class="rounded text-emerald-500 focus:ring-emerald-500">
                                        <span class="text-sm font-medium text-gray-700">¿Incluir Export Manager?</span>
                                    </label>
                                    <select id="exportManagerSelect" class="custom-select hidden">
                                        <option value="manager1">Export Manager Pro X1</option>
                                    </select>
                                    <div id="exportManagerQuantity" class="hidden">
                                        <label class="form-label flex items-center">
                                            Cantidad de Export Manager
                                            <span class="help-icon" title="Número de Export Manager a instalar">
                                                <i class="fas fa-circle-question text-sm"></i>
                                            </span>
                                        </label>
                                        <input type="number" id="exportQuantity_input" min="0" value="0" class="custom-input">
                                    </div>
                                </div>
                            </div>

                            <!-- Medidor Bidireccional -->
                            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-100">
                                <div class="space-y-4">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" id="medidorBidireccional" class="rounded text-emerald-500 focus:ring-emerald-500">
                                        <span class="text-sm font-medium text-gray-700">
                                            ¿Incluir medidor bidireccional?
                                            <span class="help-icon" title="Medidor que permite registrar tanto el consumo como la energía generada">
                                                <i class="fas fa-circle-question text-sm"></i>
                                            </span>
                                        </span>
                                    </label>
                                    <select id="medidorBidireccionalSelect" class="custom-select hidden">
                                        <option value="medidor1">Medidor Monofásico 120/240V</option>
                                        <option value="medidor2">Medidor Bifásico 240V</option>
                                        <option value="medidor3">Medidor Trifásico 208/120V</option>
                                    </select>
                                    <div id="medidorBidireccionalQuantity" class="hidden">
                                        <label class="form-label flex items-center">
                                            Cantidad de medidores
                                            <span class="help-icon" title="Número de medidores a instalar">
                                                <i class="fas fa-circle-question text-sm"></i>
                                            </span>
                                        </label>
                                        <input type="number" id="medidorBidireccionalQuantity_input" min="0" value="0" class="custom-input">
                                    </div>
                                </div>
                            </div>

                            <!-- Tipo de Teja -->
                            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-100">
                                <h3 class="text-lg font-medium text-gray-800 mb-4">Tipo de Teja</h3>
                                <div class="space-y-4">
                                    <div class="relative">
                                        <label class="form-label flex items-center">
                                            Tipo de Teja
                                            <span class="help-icon" title="Seleccione el tipo de teja donde se instalarán los paneles">
                                                <i class="fas fa-circle-question text-sm"></i>
                                            </span>
                                        </label>
                                        <select id="tipoTeja" class="custom-select">
                                            <option value="">Seleccione el tipo de teja</option>
                                        </select>
                                    </div>
                                    <div class="relative">
                                        <label class="form-label flex items-center">
                                            Cantidad de tejas
                                            <span class="help-icon" title="Número de tejas a instalar">
                                                <i class="fas fa-circle-question text-sm"></i>
                                            </span>
                                        </label>
                                        <input type="number" id="tejasQuantity_input" min="0" value="0" class="custom-input">
                                    </div>
                                    <div id="tejaPreview" class="mt-4">
                                        <img id="tejaImage" class="max-w-xs rounded-lg hidden" alt="Vista previa de teja">
                                        <p id="tejaPrecio" class="mt-2 text-sm text-gray-600"></p>
                                    </div>
                                </div>
                            </div>

                            <!-- Consultoría Tributaria -->
                            <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-100">
                                <div class="mb-4">
                                    <a href="#" class="text-emerald-500 hover:text-emerald-600 flex items-center gap-2">
                                        <i class="fas fa-play-circle"></i>
                                        Aprende sobre los beneficios tributarios
                                    </a>
                                </div>
                                <div class="space-y-2">
                                    <label class="flex items-center space-x-2 cursor-pointer">
                                        <input type="checkbox" id="consultoriaTributaria" class="rounded text-emerald-500 focus:ring-emerald-500">
                                        <span class="text-sm font-medium text-gray-700">¿Incluir consultoría de beneficios tributarios?</span>
                                    </label>
                                </div>
                            </div>

                            <!-- Resumen de Costos -->
                            <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">Resumen de Costos</h3>
                                <div id="costSummary" class="space-y-2 text-gray-700"></div>
                                <div class="mt-6 pt-4 border-t border-gray-200">
                                    <div class="flex items-center justify-between">
                                        <p class="text-lg font-bold text-gray-900">Total Estimado:</p>
                                        <p class="text-2xl font-bold text-emerald-600" id="totalPrice">$0</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Campos ocultos necesarios -->
                            <div class="hidden">
                                <div id="protectorInversorQuantity"></div>
                                <div id="solisCTQuantity"></div>
                                <select id="protectorInversorSelect"></select>
                                <select id="solisCTSelect"></select>
                                <select id="estudioConexionSelect"></select>
                                <select id="protectorQuantity"></select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navegación -->
                <div class="flex justify-between mt-8 pt-6 border-t border-gray-100">
                    <button id="prevBtn" class="custom-button secondary-button hidden">
                        <i class="fas fa-arrow-left"></i>
                        Anterior
                    </button>
                    <button id="nextBtn" class="custom-button primary-button ml-auto">
                        Siguiente
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <button id="submitBtn" class="custom-button primary-button ml-auto hidden">
                        <i class="fas fa-download"></i>
                        Descargar Cotización
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom image 
    <div class="fixed bottom-0 w-full">
        <img src="https://via.placeholder.com/1920x200" alt="Footer Image" class="w-full h-32 object-cover">
    </div>
-->
    <script>

        let locations = [];

        function initializeLocations() {
            fetch('/api/locations/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    locations = data;
                    if (Array.isArray(data) && data.length > 0) {
                        data.forEach(location => {
                            const option = document.createElement('option');
                            option.value = location.id;
                            option.textContent = location.nombre;
                            locationSelect.insertBefore(option, locationSelect.lastElementChild);
                        });
                    } else {
                    }
                })
                .catch(error => {
                    // Opcional: mostrar mensaje de error al usuario
                    const errorOption = document.createElement('option');
                    errorOption.textContent = 'Error cargando ubicaciones';
                    errorOption.disabled = true;
                    locationSelect.appendChild(errorOption);
                });
        }

        function calculateTravelCosts() {
            if (locationSelect.value === "Medellin"){
                //console.log("NO HUBO COBRO Travel")
                return 0;
            }
            let distance = 0;
            try {
                if (locationSelect.value === 'custom') {
                    distance = parseFloat(customDistance.value) || 0;
                } else if (locationSelect.value && locations.length > 0) {
                    const selectedLocation = locations.find(l => l.id === parseInt(locationSelect.value));
                    if (selectedLocation) {
                        distance = selectedLocation.km_desde_medellin;
                    }
                }
            } catch (error) {
                return 0;
            }
            //console.log("SI HUBO COBRO travel: ", distance*2*2300);

            return distance * 2 * 2300;
        }

        let viaticos = null;

        // Función para cargar viáticos
        function initializeViaticos() {
            fetch('/api/viaticos/')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.json();
                })
                .then(data => {
                    viaticos = data;
                })
                .catch(error => {
                    viaticos = { precio_hospedaje: 0, precio_viaticos: 0 };
                });
        }

        // Función para calcular viáticos
        function calculateViaticosCosts() {
            if (calculateTravelCosts() === 0){
                //console.log("No hay cobro Viaticos....");
                return 0;
            }
            if (!viaticos) {
                console.warn('Datos de viáticos no disponibles');
                return 0;
            }

            const workDays = parseInt(document.getElementById('workDays').value) || 2;
            const workers = parseInt(document.getElementById('workers').value) || 2;
            
            const costoHospedaje = viaticos.precio_hospedaje * workDays * workers;
            const costoViaticos = viaticos.precio_viaticos * workDays * workers;
            //console.log("SI HUBO COBRO: Viaticos", costoHospedaje + costoViaticos);
            return costoHospedaje + costoViaticos;
        }
        /*
        // Función para seleccionar el inversor apropiado
        function selectAppropriateInverter(totalPanelPower, inversores) {
            // Filtrar inversores con inventario disponible
            const availableInversores = inversores.filter(inv => inv.sales_count > 0);
            
            // Ordenar inversores por potencia
            const sortedInversores = availableInversores.sort((a, b) => a.power - b.power);
            
            // Encontrar el inversor más cercano que cumpla con el criterio del 150%
            const appropriateInverter = sortedInversores.find(inv => 
                totalPanelPower <= inv.power * 1.5
            );
            
            return appropriateInverter || null;
        }

        // Función para validar disponibilidad de paneles
        function validatePanelAvailability(selectedPanel, requestedQuantity) {
            //Valida si hay inventario disponible
            //return selectedPanel.sales_count >= requestedQuantity;
            return true;
        }

        // Función para calcular cantidad de protectores necesarios
        function calculateProtectorsNeeded(inverterQuantity) {
            return inverterQuantity; // Un protector por inversor
        }

        */
        // Función para validar requerimiento de protección CNO
        function validateCNOProtection(totalInverterPower) {
            return totalInverterPower > 250;
        }

        // Función para validar requerimiento de estudio de conexión
        function validateConnectionStudy(totalInverterPower, transformerCapacity) {
            return totalInverterPower > (transformerCapacity * 0.5);
        }

        document.addEventListener('DOMContentLoaded', function() {

            initializeLocations();
            initializeViaticos();

            //Logica para la primera pagina
            const consumptionInput = document.getElementById('consumption');
            const costPerKwhInput = document.getElementById('costPerKwh');
            const contributionInput = document.getElementById('contribution');
            const totalBillInput = document.getElementById('totalBill');

            function calculateTotal() {
                const consumption = parseFloat(consumptionInput.value) || 0;
                const costPerKwh = parseFloat(costPerKwhInput.value) || 0;
                const contribution = parseFloat(contributionInput.value) || 0;

                const baseCost = consumption * costPerKwh;
                const contributionAmount = baseCost * (contribution / 100);
                const total = baseCost + contributionAmount;

                totalBillInput.value = total.toLocaleString('es-CO', {
                    style: 'currency',
                    currency: 'COP',
                    minimumFractionDigits: 2
                });
            }

            // Event listeners para recalcular cuando cambie cualquier valor
            consumptionInput.addEventListener('input', calculateTotal);
            costPerKwhInput.addEventListener('input', calculateTotal);
            contributionInput.addEventListener('input', calculateTotal);
            // Fin logica para la primera pagina

            let currentPage = 1;
            const totalPages = 3;
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const submitBtn = document.getElementById('submitBtn');
            const progressBar = document.getElementById('progress-bar');

            function updatePage() {
                // Hide all pages
                document.querySelectorAll('.form-page').forEach(page => {
                    page.classList.add('hidden');
                });
                
                // Show current page
                document.querySelector(`.form-page[data-page="${currentPage}"]`).classList.remove('hidden');
                
                // Update progress bar
                progressBar.style.width = `${(currentPage / totalPages) * 100}%`;
                
                // Update buttons
                prevBtn.classList.toggle('hidden', currentPage === 1);
                nextBtn.classList.toggle('hidden', currentPage === totalPages);
                submitBtn.classList.toggle('hidden', currentPage !== totalPages);
            }

            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    updatePage();
                }
            });

            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    updatePage();
                }
            });

            submitBtn.addEventListener('click', async () => {
                // Recoger todos los datos
                const formData = {
                    fullName: document.getElementById('fullName').value,
                    consumption: document.getElementById('consumption').value,
                    costPerKwh: document.getElementById('costPerKwh').value,
                    costSummary: document.getElementById('costSummary').textContent,
                    totalCost: document.getElementById('totalPrice').textContent,
                    contribution: document.getElementById('contribution').value,
                    totalBill: document.getElementById('totalBill').value,
                    transformer: document.getElementById('transformer').value,
                    availableArea: document.getElementById('availableArea').value

                };

                try {
                    const response = await fetch('/submit-form/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')  // Función para obtener el token CSRF
                        },
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        alert('Formulario enviado con éxito');
                        // Redirect or show success message
                    } else {
                        alert('Error al enviar el formulario');
                    }
                } catch (error) {
                    alert('Error al enviar el formulario');
                }
            });

            // Función para obtener el token CSRF
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            //Logica para la pagina 2
            const paneles = JSON.parse(document.getElementById('paneles-data').textContent);
            const consumoMensual = document.getElementById('consumption').value;
            // Referencias a elementos del DOM
            const manualModeBtn = document.getElementById('manualModeBtn');
            const autoModeBtn = document.getElementById('autoModeBtn');
            const manualMode = document.getElementById('manualMode');
            const autoMode = document.getElementById('autoMode');
            const panelSelect = document.getElementById('panelSelect');
            const panelInfo = document.getElementById('panelInfo');
            // Obtenemos las cantidades de los campos
            const panelQuantity = document.getElementById('panelQuantity');
            const inversorQuantity = document.getElementById('inversorQuantity_input')
            const protectorQuantity = document.getElementById('protectorQuantity_input')
            const exportManagerQuantity = document.getElementById('exportQuantity_input')
            const solisCTQuantity = document.getElementById('solisCTQuantity_input')
            const medidorBidireccionalQuantity = document.getElementById('medidorBidireccionalQuantity_input')
            const tejasQuantity = document.getElementById('tejasQuantity_input')

            const coverageInfo = document.getElementById('coverageInfo');
            const desiredCoverage = document.getElementById('desiredCoverage');
            const recommendationInfo = document.getElementById('recommendationInfo');
            // Cargar datos de tejas
            const tejas = JSON.parse(document.getElementById('tejas-data').textContent);
            const tipoTejaSelect = document.getElementById('tipoTeja');
            const tejaImage = document.getElementById('tejaImage');
            const tejaPrecio = document.getElementById('tejaPrecio');

            /*
            //logica para los paneles
            panelQuantity.addEventListener('input', function() {
                const quantity = parseInt(this.value) || 0;
                const selectedPanel = paneles.find(p => p.id === parseInt(panelSelect.value));
                
                if (selectedPanel) {
                    if (!validatePanelAvailability(selectedPanel, quantity)) {
                        alert(`Solo hay ${selectedPanel.sales_count} paneles disponibles en inventario`);
                        this.value = selectedPanel.sales_count;
                        return;
                    }
                    
                    const totalPower = selectedPanel.power * quantity;
                    const appropriateInverter = selectAppropriateInverter(totalPower, inversores);
                    
                    if (appropriateInverter) {
                        inversorSelect.value = appropriateInverter.id;
                        // Actualizar cantidad de protectores necesarios
                        const protectorsNeeded = calculateProtectorsNeeded(1); // Asumiendo 1 inversor inicialmente
                        document.getElementById('protectorQuantity_input').value = protectorsNeeded;
                    }
                }
                calculateTotalCost();
            });

            // Para la validación de estudio de conexión
            document.getElementById('transformer').addEventListener('input', function() {
                const transformerCapacity = parseFloat(this.value) || 0;
                const totalInverterPower = selectedInversor ? selectedInversor.power * inversorQuantity : 0;
                
                const needsStudy = validateConnectionStudy(totalInverterPower, transformerCapacity);
                document.getElementById('estudioConexion').disabled = !needsStudy;
                if (!needsStudy) {
                    document.getElementById('estudioConexion').checked = false;
                    document.getElementById('estudioConexionSelect').classList.add('hidden');
                }
            });

            // Para la validación de SolisCT con Export Manager
            document.getElementById('exportManager').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('solisCT').checked = true;
                    document.getElementById('solisCTSelect').classList.remove('hidden');
                    document.getElementById('solisCTQuantity').classList.remove('hidden');
                }
            });
            */

            // Poblar selector de tejas
            tejas.forEach(teja => {
                const option = document.createElement('option');
                option.value = teja.id;
                option.textContent = teja.nombre;
                tipoTejaSelect.appendChild(option);
            });

            // Manejar cambio de teja seleccionada
            tipoTejaSelect.addEventListener('change', function() {
                const selectedTeja = tejas.find(t => t.id === parseInt(this.value));
                if (selectedTeja) {
                    console.log("URL DE LA TEJA", selectedTeja.imagen);
                    console.log("Teja seleccionada: ",selectedTeja.id);
                    console.log("PRECIO TEJA: ",selectedTeja.precio_antes_de_iva.toLocaleString());
                    tejaImage.src = selectedTeja.imagen;
                    tejaImage.classList.remove('hidden');
                    tejaPrecio.textContent = `Precio: $${selectedTeja.precio_antes_de_iva.toLocaleString()}`;
                } else {
                    tejaImage.classList.add('hidden');
                    tejaPrecio.textContent = '';
                }
                calculateTotalCost();
            });

            // cargar datos de estudio de conexión
            const estudios_conexion = JSON.parse(document.getElementById('estudio_conexion-data').textContent);
            const estudioConexionSelect = document.getElementById('estudioConexionSelect');

            // Poblar el selector de estudio de conexión
            estudios_conexion.forEach(estudio_conexion => {
                const option = document.createElement('option');
                option.value = estudio_conexion.id;
                option.textContent =  estudio_conexion.nombre;
                estudioConexionSelect.appendChild(option);
            });


            // Poblar el selector de paneles
            paneles.forEach(panel => {
                const option = document.createElement('option');
                option.value = panel.id;
                option.textContent = panel.name;
                panelSelect.appendChild(option);
            });

            // Cambio entre modos manual y automático
            manualModeBtn.addEventListener('click', () => {
                manualMode.classList.remove('hidden');
                autoMode.classList.add('hidden');
                manualModeBtn.classList.add('bg-blue-500', 'text-white');
                autoModeBtn.classList.remove('bg-blue-500', 'text-white');
            });

            autoModeBtn.addEventListener('click', () => {
                autoMode.classList.remove('hidden');
                manualMode.classList.add('hidden');
                autoModeBtn.classList.add('bg-blue-500', 'text-white');
                manualModeBtn.classList.remove('bg-blue-500', 'text-white');
            });

            // Función para calcular la cobertura
            function calculateCoverage(panelPower, quantity, consumption, hsp, security_factor) {
                const dailyProduction = panelPower * quantity * hsp * security_factor;
                const monthlyProduction = dailyProduction * 30;
                //Convertimos de watts a kwatts
                const monthlyProduction_KW = monthlyProduction / 1000
                const coverage = (monthlyProduction_KW / consumption) * 100;
                return Math.min(coverage, 100);
            }

            // Actualizar información del panel seleccionado
            panelSelect.addEventListener('change', () => {
                const selectedPanel = paneles.find(p => p.id === parseInt(panelSelect.value));
                if (selectedPanel) {
                    panelInfo.innerHTML = `
                        <p>Potencia: ${selectedPanel.power}W</p>
                        <p>Área: ${(selectedPanel.panel_area_in_cm / 10000).toFixed(2)}m²</p>
                        <p>Precio estimado por unidad: $${selectedPanel.panel_price.toLocaleString()}</p>
                    `;
                    calculateManualCoverage();
                }
            });

            // Calcular cobertura en modo manual
            function calculateManualCoverage() {
                const selectedPanel = paneles.find(p => p.id === parseInt(panelSelect.value));
                const quantity = parseInt(panelQuantity.value) || 0;
                const consumption = parseFloat(document.getElementById('consumption').value) || 0;

                if (selectedPanel && quantity > 0 && consumption > 0) {
                    const security_factor = 0.79
                    const hsp = 4.40
                    const coverage = calculateCoverage(selectedPanel.power, quantity, consumption, hsp, security_factor);
                    coverageInfo.innerHTML = `
                        <p>Cobertura estimada: ${coverage.toFixed(1)}%</p>
                        <p>Producción mensual estimada: ${(((selectedPanel.power * quantity * security_factor * hsp)/1000) * 30).toFixed(2)} kWh</p>
                    `;
                }
            }

            // Calcular recomendación automática
            function calculateAutoRecommendation() {
                const consumption = parseFloat(document.getElementById('consumption').value) || 0;
                const desiredPercentage = parseFloat(desiredCoverage.value) || 80;
                const targetProduction = (consumption * desiredPercentage) / 100;

                // Encontrar la mejor combinación de paneles
                let bestOption = null;
                let lowestCost = Infinity;
                const hsp = 4.4
                const security_factor = 0.79

                paneles.forEach(panel => {
                    const neededPanels = Math.ceil(targetProduction / ((panel.power * hsp * 30 * 0.79)/1000));
                    const totalCost = neededPanels * panel.panel_price;

                    if (totalCost < lowestCost) {
                        lowestCost = totalCost;
                        bestOption = {
                            panel: panel,
                            quantity: neededPanels,
                            cost: totalCost
                        };
                    }
                });

                if (bestOption) {
                    recommendationInfo.innerHTML = `
                        <p>Panel recomendado: ${bestOption.panel.name}</p>
                        <p>Cantidad: ${bestOption.quantity} unidades</p>
                        <p>Potencia total: ${(bestOption.panel.power * bestOption.quantity).toFixed(2)}W</p>
                        <p>Inversión estimada: $${bestOption.cost.toLocaleString()}</p>
                    `;
                }
            }

            // Event listeners
            panelQuantity.addEventListener('input', calculateManualCoverage);
            inversorQuantity.addEventListener('input',calculateTotalCost);
            //protectorQuantity.addEventListener('input',calculateTotalCost);
            desiredCoverage.addEventListener('input', calculateAutoRecommendation);
            exportManagerQuantity.addEventListener('input',calculateTotalCost);
            //solisCTQuantity.addEventListener('input',calculateTotalCost);
            medidorBidireccionalQuantity.addEventListener('input',calculateTotalCost);
            tejasQuantity.addEventListener('input',calculateTotalCost);


            // Manejo de checkboxes y selects
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                const select = document.getElementById(checkbox.id + 'Select');
                const quantity_check = document.getElementById(checkbox.id + 'Quantity');
                if (select) {
                    checkbox.addEventListener('change', () => {
                        select.classList.toggle('hidden', !checkbox.checked);
                        calculateTotalCost();
                    });
                }
                if (quantity_check) {
                    checkbox.addEventListener('change', () => {
                        quantity_check.classList.toggle('hidden', !checkbox.checked);
                        calculateTotalCost();
                    });
                }
            });

            // Cargar tipos de teja
            const tejaPreview = document.getElementById('tejaPreview');

            // Esta función se llamaría cuando los datos de tejas estén disponibles
            function loadTejas(tejas) {
                tejas.forEach(teja => {
                    const option = document.createElement('option');
                    option.value = teja.id;
                    option.textContent = teja.nombre;
                    tipoTejaSelect.appendChild(option);
                });
            }

            tipoTejaSelect.addEventListener('change', function() {
                // Aquí actualizarías la imagen de la teja seleccionada
                const selectedTeja = tejas.find(t => t.id === parseInt(this.value));
                if (selectedTeja) {
                    tejaPreview.innerHTML = `<img src="${selectedTeja.imagen}" alt="${selectedTeja.nombre}" class="max-w-xs rounded-lg">`;
                }
                calculateTotalCost();
            });
            

            //añadir bd de medidores bidireccional
            function getMedidorCost() {
                const medidorSelect = document.getElementById('medidorBidireccionalSelect');
                switch(medidorSelect.value) {
                    case 'medidor1': return 800000;
                    case 'medidor2': return 1200000;
                    case 'medidor3': return 1500000;
                    default: return 0;
                }
            }

            // Llamar a calculateTotalCost cuando cambie cualquier selección
            document.querySelectorAll('select, input[type="checkbox"]').forEach(element => {
                element.addEventListener('change', calculateTotalCost);
            });


            // Cargar datos externos
            const datos_externos = JSON.parse(document.getElementById('datos_externos-data').textContent);
            const inversores = JSON.parse(document.getElementById('inversores-data').textContent);

            // Configurar HSP y factor de seguridad desde datos externos
            const hsp = datos_externos.hsp;
            const security_factor = datos_externos.security_factor;

            // Poblar selector de inversores
            const inversorSelect = document.getElementById('inversorSelect');
            inversores.forEach(inversor => {
                const option = document.createElement('option');
                option.value = inversor.id;
                option.textContent = `${inversor.name} - ${inversor.power}W`;
                inversorSelect.appendChild(option);
            });

            // Manejo de ubicaciones
            const locationSelect = document.getElementById('locationSelect');
            const customLocationDiv = document.getElementById('customLocationDiv');
            const customLocation = document.getElementById('customLocation');
            const customDistance = document.getElementById('customDistance');

            document.getElementById('workDays').addEventListener('input', calculateTotalCost);
            document.getElementById('workers').addEventListener('input', calculateTotalCost);
            document.getElementById('customDistance').addEventListener('input', calculateTotalCost);
            locationSelect.addEventListener('change', calculateTotalCost);

            // Modificar la función calculateTotalCost existente
            function calculateTotalCost() {
                let totalCost = 0;
                let totalCostSinIva = 0;

                // Costo base del sistema (paneles + inversores)
                const selectedPanel = paneles.find(p => p.id === parseInt(panelSelect.value));
                const quantity = parseInt(panelQuantity.value) || 0;

                if (selectedPanel && quantity > 0) {
                    totalCost += (selectedPanel.panel_price * quantity) + (datos_externos.pct_instalacion * selectedPanel.panel_price * quantity);
                    console.log("panel: ",(selectedPanel.panel_price * quantity) + (datos_externos.pct_instalacion * selectedPanel.panel_price * quantity))
                    totalCostSinIva += (selectedPanel.panel_price * quantity) + (datos_externos.pct_instalacion * selectedPanel.panel_price * quantity);
                }
                
                let estudio_precio = 0
                let estudioavailable = false
                // Agregar costo del inversor
                const selectedInversor = inversores.find(inv => inv.id === parseInt(inversorSelect.value));
                const inversorQuantity = parseInt(document.getElementById('inversorQuantity_input').value) || 0;
                const selectedProteccionCNO = false
                if (selectedInversor) {
                    const inversorQuantity = parseInt(document.getElementById('inversorQuantity_input').value) || 0;
                    console.log("Inversor: ",(selectedInversor.inversor_price * inversorQuantity) + (datos_externos.pct_instalacion * selectedInversor.inversor_price * inversorQuantity))
                    totalCost += (selectedInversor.inversor_price * inversorQuantity) + (datos_externos.pct_instalacion * selectedInversor.inversor_price * inversorQuantity);
                    totalCostSinIva += (selectedInversor.inversor_price * inversorQuantity) + (datos_externos.pct_instalacion * selectedInversor.inversor_price * inversorQuantity);
                    // Agregar proteccion CNO
                    const totalInverterPower = selectedInversor ? selectedInversor.power * inversorQuantity : 0;
                    if (validateCNOProtection(totalInverterPower)) {
                        const proteccionCNOCost = datos_externos.proteccionCNO;
                        totalCost += proteccionCNOCost;
                        totalCostSinIva += proteccionCNOCost;
                        console.log("Costo protecion CNO: ",proteccionCNOCost);
                        selectedProteccionCNO = true;
                    }

                    // Validación estudio de conexión
                    const transformerCapacity = document.getElementById('transformer').value;
                    const estudiosConexion = JSON.parse(document.getElementById('estudio_conexion-data').textContent);

                    
                    if (validateConnectionStudy(totalInverterPower, transformerCapacity)){
                        const selectedEstudioConexión = estudiosConexion.find(estudio => 
                            totalInverterPower >= estudio.desde && 
                            totalInverterPower <= estudio.hasta
                        );

                        if (!selectedEstudioConexión) {
                            console.log("No se encontró un estudio de conexión apropiado");
                        }
                        estudio_precio = selectedEstudioConexión.precio;
                        estudioavailable = true;
                        totalCost += estudio_precio + (datos_externos.pct_iva * estudio_precio);
                        console.log("Estudio_conexion: ",estudio_precio + (datos_externos.pct_iva * estudio_precio));
                        totalCostSinIva += estudio_precio;
                    };
                }

                // Costos adicionales según selecciones
                if (inversorQuantity > 0) {
                    //const protectorQuantity = parseInt(document.getElementById('protectorQuantity_input').value) || 0;
                    const protectorQuantity = inversorQuantity;
                    totalCost += ( 1428853 * protectorQuantity) + (datos_externos.pct_instalacion * 1428853 * protectorQuantity) + (datos_externos.pct_iva * (( 1428853 * protectorQuantity) + (datos_externos.pct_instalacion * 1428853 * protectorQuantity))); // Precio ejemplo
                    console.log("protector: ",( 1428853 * protectorQuantity) + (datos_externos.pct_instalacion * 1428853 * protectorQuantity) + (datos_externos.pct_iva * (( 1428853 * protectorQuantity) + (datos_externos.pct_instalacion * 1428853 * protectorQuantity))));
                    totalCostSinIva += ( 1428853 * protectorQuantity) + (datos_externos.pct_instalacion * 1428853 * protectorQuantity) 
                }
                const exportManagerQuantity = parseInt(document.getElementById('exportQuantity_input').value) || 0;
                if (document.getElementById('exportManager').checked) {
                    //const exportManagerQuantity = parseInt(document.getElementById('exportQuantity_input').value) || 0;
                    console.log("export_manager: ",(415942 * exportManagerQuantity) + (datos_externos.pct_instalacion * 415942 * exportManagerQuantity) + (datos_externos.pct_iva * ((415942 * exportManagerQuantity) + (datos_externos.pct_instalacion * 415942 * exportManagerQuantity))))
                    totalCost += (415942 * exportManagerQuantity) + (datos_externos.pct_instalacion * 415942 * exportManagerQuantity) + (datos_externos.pct_iva * ((415942 * exportManagerQuantity) + (datos_externos.pct_instalacion * 415942 * exportManagerQuantity))); // Precio ejemplo
                    totalCostSinIva += (415942 * exportManagerQuantity) + (datos_externos.pct_instalacion * 415942 * exportManagerQuantity)
                }

                if (exportManagerQuantity > 0) {
                    //const solisCTQuantity = parseInt(document.getElementById('solisCTQuantity_input').value) || 0;
                    const solisCTQuantity = exportManagerQuantity;
                    console.log("SolisCT: ",(288889 * solisCTQuantity) + (datos_externos.pct_instalacion * 288889 * solisCTQuantity) + (datos_externos.pct_iva * ((288889 * solisCTQuantity) + (datos_externos.pct_instalacion * 288889 * solisCTQuantity))))
                    totalCost += (288889 * solisCTQuantity) + (datos_externos.pct_instalacion * 288889 * solisCTQuantity) + (datos_externos.pct_iva * ((288889 * solisCTQuantity) + (datos_externos.pct_instalacion * 288889 * solisCTQuantity))); // Precio ejemplo
                    totalCostSinIva += (288889 * solisCTQuantity) + (datos_externos.pct_instalacion * 288889 * solisCTQuantity)
                }
                //teja

                const selectedTejaId = parseInt(tipoTejaSelect.value);

                if (selectedTejaId) {
                    const selectedTeja = tejas.find(t => t.id === selectedTejaId);
                    if (selectedTeja) {
                        const tejasQuantity = parseInt(document.getElementById('tejasQuantity_input').value) || 0;
                        console.log("Tejas: ",(selectedTeja.precio_antes_de_iva * tejasQuantity ) + (datos_externos.pct_instalacion * selectedTeja.precio_antes_de_iva * tejasQuantity) + (datos_externos.pct_iva * ((selectedTeja.precio_antes_de_iva * tejasQuantity ) + (datos_externos.pct_instalacion * selectedTeja.precio_antes_de_iva * tejasQuantity))))
                        totalCost += (selectedTeja.precio_antes_de_iva * tejasQuantity ) + (datos_externos.pct_instalacion * selectedTeja.precio_antes_de_iva * tejasQuantity) + (datos_externos.pct_iva * ((selectedTeja.precio_antes_de_iva * tejasQuantity ) + (datos_externos.pct_instalacion * selectedTeja.precio_antes_de_iva * tejasQuantity)));
                        totalCostSinIva += (selectedTeja.precio_antes_de_iva * tejasQuantity ) + (datos_externos.pct_instalacion * selectedTeja.precio_antes_de_iva * tejasQuantity) 
                    
                    }
                }
                // Agregar costo del medidor bidireccional si está seleccionado
                if (document.getElementById('medidorBidireccional').checked) {
                    const medidorBidireccionalQuantity = parseInt(document.getElementById('medidorBidireccionalQuantity_input').value) || 0;
                    const medidorSelect = document.getElementById('medidorBidireccionalSelect');
                    switch(medidorSelect.value) {
                        case 'medidor1':
                            totalCost += ( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_iva * (( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity))); // Precio ejemplo medidor monofásico
                            console.log("medidor bidereccional: ",( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_iva * (( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity))))
                            
                            totalCostSinIva += ( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity)
                            break;
                        case 'medidor2':
                            totalCost += (1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_iva * (( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity))); // Precio ejemplo medidor bifásico
                            totalCostSinIva += ( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity)
                            break;
                        case 'medidor3':
                            totalCost += ( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_iva * (( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity))); // Precio ejemplo medidor trifásico
                            totalCostSinIva += ( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity)
                            break;
                    }
                }

                //Agregar mas costos si a futuro existen    

                // Agregar costos externos
                let consultoriaCost = 0
                totalCost += datos_externos.material_electrico + (datos_externos.pct_instalacion * datos_externos.material_electrico) + (datos_externos.pct_iva * (datos_externos.material_electrico + (datos_externos.pct_instalacion * datos_externos.material_electrico)));
                console.log("MAterial electrico: ",datos_externos.material_electrico + (datos_externos.pct_instalacion * datos_externos.material_electrico) + (datos_externos.pct_iva * (datos_externos.material_electrico + (datos_externos.pct_instalacion * datos_externos.material_electrico))))


                totalCostSinIva += datos_externos.material_electrico + (datos_externos.pct_instalacion * datos_externos.material_electrico)
                certificacion_retie = (((datos_externos.certificacion_retie_v1 * Math.log((selectedPanel.power/1000)*quantity))-datos_externos.certificacion_retie_v2)/0.6 );
                console.log("Certifiación: ",(Math.round(certificacion_retie)) + (datos_externos.pct_instalacion * certificacion_retie) + (datos_externos.pct_iva * ((Math.round(certificacion_retie)) + (datos_externos.pct_instalacion * certificacion_retie))))
                totalCost += (Math.round(certificacion_retie)) + (datos_externos.pct_instalacion * certificacion_retie) + (datos_externos.pct_iva * ((Math.round(certificacion_retie)) + (datos_externos.pct_instalacion * certificacion_retie)));
                totalCostSinIva += (Math.round(certificacion_retie)) + (datos_externos.pct_instalacion * certificacion_retie)
                // Consultoría tributaria (2.5% del subtotal)
                if (document.getElementById('consultoriaTributaria').checked) {
                    totalCost += (totalCostSinIva * datos_externos.consultoria_tributaria) + (datos_externos.pct_iva * totalCostSinIva * datos_externos.consultoria_tributaria);
                    console.log("CONSULTORIA TRIBU: ",(totalCostSinIva * datos_externos.consultoria_tributaria) + (datos_externos.pct_iva * totalCostSinIva * datos_externos.consultoria_tributaria))
                    consultoriaCost = (totalCostSinIva * datos_externos.consultoria_tributaria) + (datos_externos.pct_iva * totalCostSinIva * datos_externos.consultoria_tributaria);
                    totalCostSinIva += (totalCostSinIva * datos_externos.consultoria_tributaria);
                }   

                // Agregar costos de viaje y viáticos
                if (locationSelect.value !== 'Medellin') {
                    totalCost += calculateTravelCosts();
                    totalCostSinIva += calculateTravelCosts();
                    totalCost += calculateViaticosCosts();
                    totalCostSinIva += calculateViaticosCosts();
                }

                const imprevistosAmount = totalCostSinIva * (datos_externos.imprevistos / 100);
                totalCost += imprevistosAmount;
                totalCostSinIva += totalCostSinIva * (datos_externos.imprevistos / 100);

                const tejasQuantity = parseInt(document.getElementById('tejasQuantity_input').value) || 0;
                //const selectedEstudioConexión = estudios_conexion.find(t => t.id === selectedEstudioConexionId);
                //const protectorQuantity = parseInt(document.getElementById('protectorQuantity_input').value) || 0;
                const protectorQuantity = inversorQuantity;
                //const solisCTQuantity = parseInt(document.getElementById('solisCTQuantity_input').value) || 0;
                const solisCTQuantity = exportManagerQuantity;
                
                //const exportManagerQuantity = parseInt(document.getElementById('exportQuantity_input').value) || 0;
                const medidorBidireccionalQuantity = parseInt(document.getElementById('medidorBidireccionalQuantity_input').value) || 0;


                // Actualizar el resumen de costos
                document.getElementById('costSummary').innerHTML = `
                    <p>Costo panel(es): $${(selectedPanel.panel_price * quantity + (datos_externos.pct_instalacion * selectedPanel.panel_price * quantity)).toLocaleString()}</p>
                    ${selectedInversor ? `<p>Costo inversor (es): $${((selectedInversor.inversor_price * inversorQuantity) + (datos_externos.pct_instalacion * selectedInversor.inversor_price * inversorQuantity)).toLocaleString()}</p>` : ''}
                    <p>Costo ExportManager: $${((415942 * exportManagerQuantity) + (datos_externos.pct_instalacion * 415942 * exportManagerQuantity) + (datos_externos.pct_iva * ((415942 * exportManagerQuantity) + (datos_externos.pct_instalacion * 415942 * exportManagerQuantity)))).toLocaleString()}</p>
                    <p>Costo de CTSolis: $${((288889 * solisCTQuantity) + (datos_externos.pct_instalacion * 288889 * solisCTQuantity) + (datos_externos.pct_iva * ((288889 * solisCTQuantity) + (datos_externos.pct_instalacion * 288889 * solisCTQuantity)))).toLocaleString()}</p>
                    <p>Costo de protector(es) inversor(es): $${(( 1428853 * protectorQuantity) + (datos_externos.pct_instalacion * 1428853 * protectorQuantity) + (datos_externos.pct_iva * (( 1428853 * protectorQuantity) + (datos_externos.pct_instalacion * 1428853 * protectorQuantity)))).toLocaleString()}</p>
                    ${selectedTejaId ? `<p>Teja: $${((tejas.find(t => t.id === selectedTejaId).precio_antes_de_iva * tejasQuantity ) + (datos_externos.pct_instalacion * tejas.find(t => t.id === selectedTejaId).precio_antes_de_iva * tejasQuantity) + (datos_externos.pct_iva * ((tejas.find(t => t.id === selectedTejaId).precio_antes_de_iva * tejasQuantity ) + (datos_externos.pct_instalacion * tejas.find(t => t.id === selectedTejaId).precio_antes_de_iva * tejasQuantity)))).toLocaleString()}</p>` : ''}
                    <p>Material eléctrico: $${(datos_externos.material_electrico + (datos_externos.pct_instalacion * datos_externos.material_electrico) + (datos_externos.pct_iva * (datos_externos.material_electrico + (datos_externos.pct_instalacion * datos_externos.material_electrico)))).toLocaleString()}</p>
                    <p>Certificación RETIE: $${(Math.round(certificacion_retie) + (datos_externos.pct_instalacion * certificacion_retie) + (datos_externos.pct_iva * (Math.round(certificacion_retie) + (datos_externos.pct_instalacion * certificacion_retie)))).toLocaleString()}</p>
                    ${estudioavailable ? `<p>Estudio de conexión: $${estudio_precio.toLocaleString()}</p>`:''} 
                    <p>Costo medidor bidireccional: $${(( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_iva * (( 1533333 * medidorBidireccionalQuantity) + (datos_externos.pct_instalacion * 1533333 * medidorBidireccionalQuantity)))).toLocaleString()} (Este valor puede varior dependiendo del operador de red)</p>
                    ${selectedProteccionCNO ? `<p>Costo Protección CNO: $${datos_externos.proteccionCNO.toLocaleString()}</p>`:''}
                    <p>Asesoría y Consultoría especializada (2.5%): $${consultoriaCost.toLocaleString()}
                    <p>Viáticos y transporte:(aplican si es afuera de MEDELLIN) $${(calculateViaticosCosts() + calculateTravelCosts()).toLocaleString()}</p>
                    <p>Imprevistos (${datos_externos.imprevistos}%): $${imprevistosAmount.toLocaleString()}</p>
                    <br>
                    <h3>Subtotal sin IVA: $${totalCostSinIva.toLocaleString()}</h3>
                `;
                document.getElementById('totalPrice').textContent = `$${totalCost.toLocaleString()}`;
            }
        });
    </script>
</body>
</html>